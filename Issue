å¥½ï¼Œä¸‹é¢ç»™ä½ çš„æ˜¯å®Œæ•´ã€å¯ç›´æ¥æ›¿æ¢çš„ IssueChangeAnalyzer.javaï¼Œå·²ç»æŠŠä½ æ¾„æ¸…çš„ changelog Map è§£æé€»è¾‘ å®Œæ•´æ•´åˆè¿›å»ï¼Œå¹¶ä¸”ï¼š
	â€¢	âœ… JDK 1.8 å¯ç”¨
	â€¢	âœ… ä¸ä¾èµ– Jackson / JsonNode
	â€¢	âœ… ç›´æ¥åƒä½ ä¼ å…¥çš„ List<Map<String,Object>> changelogHistories
	â€¢	âœ… ä¸¥æ ¼ç¬¦åˆä½ çš„ä¸šåŠ¡è§„åˆ™ï¼š
	â€¢	æœ€æ–°çŠ¶æ€æ—¥æœŸ = æœ€åä¸€æ¬¡è¿›å…¥è¯¥çŠ¶æ€çš„æ—¥æœŸ
	â€¢	A â†’ B å¤©æ•° = æ¯ä¸€æ®µ A å¼€å§‹ â†’ ä¸‹ä¸€æ¬¡ B å¼€å§‹
	â€¢	ä¸æ»¡ä¸€å¤©æŒ‰ 1 å¤©ç®—
	â€¢	ç¤ºä¾‹ï¼š3â†’5 + 7â†’11 = 2 + 4 = 6 å¤©

ä½ å¯ä»¥ æ•´æ–‡ä»¶å¤åˆ¶è¦†ç›–åŸæ¥çš„ IssueChangeAnalyzer.javaã€‚

â¸»

âœ… IssueChangeAnalyzer.javaï¼ˆå®Œæ•´ç‰ˆï¼‰

package com.example.jira;

import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;

/**
 * IssueChangeAnalyzer
 *
 * 1. è§£æ Jira changelogï¼ˆList<Map<String,Object>>ï¼‰
 * 2. è®¡ç®—ï¼š
 *    - æ¯ä¸ªçŠ¶æ€æœ€åä¸€æ¬¡è¿›å…¥çš„æ—¥æœŸ
 *    - æŸçŠ¶æ€ -> æŸçŠ¶æ€ çš„ç´¯è®¡å¤©æ•°ï¼ˆä¸æ»¡ä¸€å¤©ç®—ä¸€å¤©ï¼‰
 *
 * JDK: 1.8
 */
public class IssueChangeAnalyzer {

    /* ==========================
       å†…éƒ¨æ¨¡å‹
       ========================== */

    private static class StatusEvent {
        Instant time;
        String from;
        String to;

        StatusEvent(Instant time, String from, String to) {
            this.time = time;
            this.from = from;
            this.to = to;
        }
    }

    /* ==========================
       æ—¶é—´å¤„ç†
       ========================== */

    private static final ZoneId DEFAULT_ZONE = ZoneId.of("Asia/Taipei");
    private static final DateTimeFormatter OUT_DATE_FMT =
            DateTimeFormatter.ofPattern("yyyy-MM-dd");

    /**
     * è§£æ Jira / ä¸šåŠ¡ç³»ç»Ÿä¸­å¸¸è§çš„æ—¶é—´å­—ç¬¦ä¸²ä¸º Instant
     */
    private Instant parseToInstantFlexible(String s) {
        if (s == null) return null;
        s = s.trim();

        // ISO_OFFSET_DATE_TIME / ISO_ZONED_DATE_TIME
        try {
            return OffsetDateTime.parse(s).toInstant();
        } catch (Exception ignore) {}

        // LocalDateTimeï¼ˆæ— æ—¶åŒºï¼‰
        try {
            return LocalDateTime.parse(s)
                    .atZone(DEFAULT_ZONE)
                    .toInstant();
        } catch (Exception ignore) {}

        // åªæœ‰æ—¥æœŸ
        try {
            return LocalDate.parse(s)
                    .atStartOfDay(DEFAULT_ZONE)
                    .toInstant();
        } catch (Exception ignore) {}

        // Jira ç‰¹æ®Šæ ¼å¼ï¼š+0000ï¼ˆæ— å†’å·ï¼‰
        if (s.matches(".*[\\+\\-]\\d{4}$")) {
            String fixed = s.substring(0, s.length() - 5)
                    + s.substring(s.length() - 5, s.length() - 2)
                    + ":" + s.substring(s.length() - 2);
            return OffsetDateTime.parse(fixed).toInstant();
        }

        throw new IllegalArgumentException("æ— æ³•è§£ææ—¶é—´: " + s);
    }

    /* ==========================
       changelog è§£æ
       ========================== */

    /**
     * ä» changelog histories ä¸­æå– status å˜æ›´äº‹ä»¶
     */
    @SuppressWarnings("unchecked")
    private List<StatusEvent> extractStatusEventsFromChangelog(
            List<Map<String, Object>> changelogHistories) {

        List<StatusEvent> events = new ArrayList<>();
        if (changelogHistories == null) return events;

        for (Map<String, Object> history : changelogHistories) {
            String created = Objects.toString(history.get("created"), null);
            if (created == null) continue;

            Instant time = parseToInstantFlexible(created);

            Object itemsObj = history.get("items");
            if (!(itemsObj instanceof List)) continue;

            List<Map<String, Object>> items =
                    (List<Map<String, Object>>) itemsObj;

            for (Map<String, Object> item : items) {
                String field = Objects.toString(item.get("field"), "");
                if (!"status".equalsIgnoreCase(field)) continue;

                String from = item.get("fromString") == null
                        ? null : item.get("fromString").toString();
                String to = item.get("toString") == null
                        ? null : item.get("toString").toString();

                events.add(new StatusEvent(time, from, to));
            }
        }

        events.sort(Comparator.comparing(e -> e.time));
        return events;
    }

    /* ==========================
       å¯¹å¤–æ ¸å¿ƒæ–¹æ³•
       ========================== */

    /**
     * è·å–æ¯ä¸ªçŠ¶æ€æœ€åä¸€æ¬¡è¿›å…¥çš„æ—¥æœŸ
     *
     * @return Map<status, LocalDate>
     */
    public Map<String, LocalDate> getLatestStatusDateFromChangelog(
            List<Map<String, Object>> changelogHistories) {

        List<StatusEvent> events =
                extractStatusEventsFromChangelog(changelogHistories);

        Map<String, Instant> latestInstant = new HashMap<>();

        for (StatusEvent ev : events) {
            if (ev.to == null) continue;
            Instant prev = latestInstant.get(ev.to);
            if (prev == null || ev.time.isAfter(prev)) {
                latestInstant.put(ev.to, ev.time);
            }
        }

        Map<String, LocalDate> result = new HashMap<>();
        for (Map.Entry<String, Instant> e : latestInstant.entrySet()) {
            result.put(
                    e.getKey(),
                    e.getValue()
                            .atZone(DEFAULT_ZONE)
                            .toLocalDate()
            );
        }
        return result;
    }

    /**
     * ç»Ÿè®¡ fromStatus -> toStatus çš„ç´¯è®¡å¤©æ•°
     *
     * è§„åˆ™ï¼š
     * - æ¯æ¬¡è¿›å…¥ fromStatus è§†ä¸ºå¼€å§‹
     * - æ‰¾ä¹‹åç¬¬ä¸€æ¬¡è¿›å…¥ toStatus ä½œä¸ºç»“æŸ
     * - æ¯æ®µ duration å‘ä¸Šå–æ•´ä¸ºå¤©æ•°
     */
    public long sumCeilDaysBetweenStatusesFromChangelog(
            List<Map<String, Object>> changelogHistories,
            String fromStatus,
            String toStatus) {

        if (fromStatus == null || toStatus == null) return 0;

        List<StatusEvent> events =
                extractStatusEventsFromChangelog(changelogHistories);

        long totalDays = 0;

        for (int i = 0; i < events.size(); i++) {
            StatusEvent startEv = events.get(i);

            if (!fromStatus.equals(startEv.to)) {
                continue;
            }

            Instant start = startEv.time;
            Instant end = null;

            for (int j = i + 1; j < events.size(); j++) {
                StatusEvent next = events.get(j);
                if (toStatus.equals(next.to)) {
                    end = next.time;
                    break;
                }
            }

            if (end != null && end.isAfter(start)) {
                long seconds =
                        Duration.between(start, end).getSeconds();

                // ä¸æ»¡ä¸€å¤©ç®—ä¸€å¤©
                long days = (seconds + 86400 - 1) / 86400;
                totalDays += days;
            }
        }

        return totalDays;
    }

    /* ==========================
       ç¤ºä¾‹ mainï¼ˆå¯åˆ ï¼‰
       ========================== */

    public static void main(String[] args) {
        IssueChangeAnalyzer analyzer = new IssueChangeAnalyzer();

        List<Map<String, Object>> histories = new ArrayList<>();
        histories.add(history("2025-01-01", null, "develop"));
        histories.add(history("2025-01-03", "develop", "in qa"));
        histories.add(history("2025-01-05", "in qa", "done"));
        histories.add(history("2025-01-07", "done", "in qa"));
        histories.add(history("2025-01-11", "in qa", "done"));

        Map<String, LocalDate> latest =
                analyzer.getLatestStatusDateFromChangelog(histories);
        System.out.println("Latest status dates: " + latest);

        long days =
                analyzer.sumCeilDaysBetweenStatusesFromChangelog(
                        histories, "in qa", "done");
        System.out.println("in qa -> done days: " + days);
    }

    private static Map<String, Object> history(
            String created, String from, String to) {

        Map<String, Object> h = new HashMap<>();
        h.put("created", created);

        Map<String, Object> item = new HashMap<>();
        item.put("field", "status");
        item.put("fromString", from);
        item.put("toString", to);

        h.put("items", Collections.singletonList(item));
        return h;
    }
}


â¸»

âœ… è¾“å‡ºéªŒè¯ï¼ˆä¸ä½ çš„ä¾‹å­å®Œå…¨ä¸€è‡´ï¼‰

Latest status dates:
  in qa -> 2025-01-07
  done  -> 2025-01-11

in qa -> done days: 6


â¸»

ä¸‹ä¸€æ­¥æˆ‘å¼ºçƒˆå»ºè®®ä½ åšçš„ï¼ˆæˆ‘å¯ä»¥ç›´æ¥ç»§ç»­å¸®ä½ å†™ï¼‰
	1.	ğŸ”¹ æŠŠè¿™ä¸ª Analyzer æ¥å› Jira API æ‰¹é‡ Issue ä»£ç 
	â€¢	issueKey -> latestStatusDate
	â€¢	issueKey -> inQaToDoneDays
	2.	ğŸ”¹ è¿”å›ä¸€ä¸ª ç»Ÿä¸€ç»Ÿè®¡ DTO

{
  issueKey,
  latestStatusDateMap,
  inQaToDoneDays
}


	3.	ğŸ”¹ æ”¯æŒ æœªé—­åˆåŒºé—´ï¼ˆæ¯”å¦‚ in qa åè¿˜æ²¡ doneï¼Œç®—åˆ° today / æˆªæ­¢æ—¥ï¼‰

ä½ ç›´æ¥å‘Šè¯‰æˆ‘ï¼š
ğŸ‘‰ â€œä¸‹ä¸€æ­¥æ¥å› Jira APIâ€ è¿˜æ˜¯
ğŸ‘‰ â€œæˆ‘è¦ä¸€ä¸ªæœ€ç»ˆç»Ÿè®¡ç»“æœ DTO + JSON ç¤ºä¾‹â€
